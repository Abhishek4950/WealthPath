<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A professional financial planning website with articles and calculators for smart money management.">
    <title>Smart Finance Planner</title>

    <!-- Canonical link tag to prevent duplicate content issues.
    Be sure to update the href with your actual website URL. -->
    <link rel="canonical" href="https://yourwebsite.com/index.html"> 

    <!-- Open Graph Meta Tags for social media sharing -->
    <meta property="og:title" content="Smart Finance Planner: Your Guide to Financial Freedom">
    <meta property="og:description" content="A professional financial planning website with articles and calculators for smart money management.">
    <meta property="og:image" content="https://placehold.co/1200x630/2563EB/ffffff?text=Smart+Finance+Planner">
    <meta property="og:url" content="https://yourwebsite.com/index.html">
    <meta property="og:type" content="website">

    <!-- Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a clean, professional font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style to hide the calculator container by default */
        .calculator-container.hidden {
            display: none;
        }

        /* Notification Modal styles */
        .notification-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .notification-modal-content {
            background-color: #fff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            text-align: center;
            position: relative;
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }

        .notification-modal-overlay.show {
            display: flex;
        }
        .notification-modal-overlay.show .notification-modal-content {
            transform: scale(1);
            opacity: 1;
        }

        /* Toast styles */
        #subscriptionToast {
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        #subscriptionToast.show {
            transform: scale(1) translateX(-50%);
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header -->
    <header class="bg-blue-600 text-white py-8 shadow-xl relative">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight">News Hub</h1>
            <p class="mt-2 text-xl sm:text-2xl font-light opacity-90">Your daily dose of Finance, Tech, and Entertainment.</p>
        </div>
        <nav class="mt-4 flex justify-center items-center">
            <ul class="flex space-x-4 md:space-x-8 text-white">
                <li><a href="#" data-category="finance" class="nav-link text-lg font-bold border-b-4 border-transparent hover:border-white transition-colors duration-300 pb-1">Finance</a></li>
                <li><a href="#" data-category="technology" class="nav-link text-lg font-bold border-b-4 border-transparent hover:border-white transition-colors duration-300 pb-1">Technology</a></li>
                <li><a href="#" data-category="entertainment" class="nav-link text-lg font-bold border-b-4 border-transparent hover:border-white transition-colors duration-300 pb-1">Entertainment</a></li>
            </ul>
        </nav>
        <!-- Notification icon and subscribe button -->
        <div class="absolute top-4 right-4 flex items-center space-x-4">
            <button id="subscribeBtn" class="bg-white text-blue-600 py-2 px-4 rounded-full text-sm font-semibold hover:bg-gray-100 transition-colors duration-200 shadow-md">
                Subscribe to All Updates
            </button>
            <button id="notificationBtn" class="relative text-white hover:text-blue-200 transition-colors duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h2v-2h-2v2zm0-4h2V7h-2v6z"/>
                </svg>
                <span id="notificationBadge" class="absolute top-0 right-0 h-4 w-4 bg-red-500 rounded-full border-2 border-white transform translate-x-1 -translate-y-1 hidden"></span>
            </button>
        </div>
        <p id="userIdDisplay" class="absolute bottom-1 left-4 text-xs text-blue-200 opacity-70 break-all"></p>
    </header>

    <!-- Subscription Confirmation Toast -->
    <div id="subscriptionToast" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-green-600 text-white py-3 px-6 rounded-lg shadow-lg z-50 opacity-0 transition-all duration-300 ease-out">
        आप अब सफलतापूर्वक सब्सक्राइब हो गए हैं! (Subscribed Successfully!)
    </div>

    <!-- Notification Modal -->
    <div id="notificationModal" class="notification-modal-overlay">
        <div class="notification-modal-content">
            <h3 class="text-2xl font-bold mb-4">New Update! <span id="notificationCategory" class="text-sm font-medium text-blue-500 bg-blue-100 px-2 py-1 rounded-full ml-2"></span></h3>
            <p id="notificationMessage" class="text-gray-600 mb-6"></p>
            <div class="mt-6 flex justify-center space-x-4">
                <a id="readNowBtn" href="#" target="_blank" class="bg-blue-600 text-white py-2 px-6 rounded-full font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-md">
                    Read Now
                </a>
                <button id="closeNotificationBtn" class="bg-gray-200 text-gray-700 py-2 px-6 rounded-full font-semibold hover:bg-gray-300 transition-colors duration-200 shadow-md">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">

        <!-- Articles Section -->
        <section id="articlesSection">
            <h2 id="sectionTitle" class="text-3xl font-bold text-center text-gray-900 mb-8">Finance Articles</h2>
            <div class="card-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8" id="blogCards">
                <!-- Cards will be generated dynamically -->
                <p id="loadingMessage" class="col-span-full text-center text-gray-500">Loading articles...</p>
            </div>
        </section>

        <!-- Dynamic Article Container -->
        <div id="articleContainer" class="bg-white rounded-xl shadow-2xl p-8 mt-12 transition-all duration-300" style="display:none;">
            <div class="mb-8">
                <img id="articleImage" src="" alt="Article image" class="w-full h-72 object-cover rounded-xl shadow-md" onerror="this.onerror=null; this.src='https://placehold.co/1200x300/e5e7eb/374151?text=Image+Unavailable';">
            </div>
            <div class="article-content text-lg leading-relaxed">
                <h2 id="articleTitle" class="text-4xl font-bold text-blue-600 mb-4"></h2>
                <div id="articleText" class="prose max-w-none text-gray-700"></div>
            </div>
            <div id="navButtons" class="flex justify-between mt-8">
                <button id="backBtn" class="flex items-center space-x-2 bg-gray-200 text-gray-700 py-3 px-6 rounded-full font-semibold hover:bg-gray-300 transition-colors duration-200 shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                    </svg>
                    <span>Back to Articles</span>
                </button>
                <button id="nextBtn" class="flex items-center space-x-2 bg-blue-600 text-white py-3 px-6 rounded-full font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-md">
                    <span>Next Article</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>

        <hr class="my-12 border-t-2 border-gray-200">

        <!-- Financial Calculators Section - now conditionally visible -->
        <section id="calculatorSection" class="calculator-container bg-white rounded-xl shadow-2xl p-8 hidden">
            <h2 class="text-3xl font-bold text-center text-gray-900 mb-8">Financial Calculators</h2>
            <div class="flex flex-col lg:flex-row space-y-8 lg:space-y-0 lg:space-x-8">

                <!-- SIP Calculator -->
                <div class="calculator-card flex-1 bg-blue-50 p-6 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-semibold text-blue-800 mb-6">SIP Calculator (Systematic Investment Plan)</h3>
                    <div class="calculator-input mb-4">
                        <label for="sipAmount" class="block font-medium mb-2">Monthly Investment (₹):</label>
                        <input type="number" id="sipAmount" value="5000" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                    </div>
                    <div class="calculator-input mb-4">
                        <label for="sipReturn" class="block font-medium mb-2">Expected Return Rate (% p.a.):</label>
                        <input type="number" id="sipReturn" value="12" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                    </div>
                    <div class="calculator-input mb-8">
                        <label for="sipYears" class="block font-medium mb-2">Time Period (Years):</label>
                        <input type="number" id="sipYears" value="10" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                    </div>
                    <button id="sipCalcBtn" class="calc-button w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition-colors shadow-md">Calculate SIP</button>
                    <div class="calculator-result mt-6 text-center text-lg font-bold p-3 bg-blue-100 rounded-lg" id="sipResult"></div>
                </div>

                <!-- Lumpsum Calculator -->
                <div class="calculator-card flex-1 bg-blue-50 p-6 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-semibold text-blue-800 mb-6">Lumpsum Calculator</h3>
                    <div class="calculator-input mb-4">
                        <label for="lumpsumAmount" class="block font-medium mb-2">Total Investment (₹):</label>
                        <input type="number" id="lumpsumAmount" value="100000" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                    </div>
                    <div class="calculator-input mb-4">
                        <label for="lumpsumReturn" class="block font-medium mb-2">Expected Return Rate (% p.a.):</label>
                        <input type="number" id="lumpsumReturn" value="12" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                    </div>
                    <div class="calculator-input mb-8">
                        <label for="lumpsumYears" class="block font-medium mb-2">Time Period (Years):</label>
                        <input type="number" id="lumpsumYears" value="10" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                    </div>
                    <button id="lumpsumCalcBtn" class="calc-button w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition-colors shadow-md">Calculate Lumpsum</button>
                    <div class="calculator-result mt-6 text-center text-lg font-bold p-3 bg-blue-100 rounded-lg" id="lumpsumResult"></div>
                </div>
            </div>
        </section>

    </main>

    <footer class="mt-12 py-8 bg-gray-100 text-center text-gray-500 text-sm">
        <p>Disclaimer: This website and its content are for informational and educational purposes only. The calculators and articles are not intended to be and do not constitute financial advice. You should not make any financial decisions based on the information provided here without consulting a qualified financial professional.</p>
    </footer>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Enable Firestore debug logging
        setLogLevel('debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        let app;
        let db;
        let auth;
        let userId = '';
        let isAuthReady = false;
        let currentCategory = 'finance';
        let articlesInCurrentCategory = [];
        let currentArticleIndex = -1;
        let userHasSubscribed = false;

        // --- DOM Elements ---
        const sectionTitle = document.getElementById('sectionTitle');
        const blogCards = document.getElementById('blogCards');
        const articleContainer = document.getElementById('articleContainer');
        const articleTitleEl = document.getElementById('articleTitle');
        const articleTextEl = document.getElementById('articleText');
        const articleImageEl = document.getElementById('articleImage');
        const backBtn = document.getElementById('backBtn');
        const nextBtn = document.getElementById('nextBtn');
        const navLinks = document.querySelectorAll('.nav-link');
        const calculatorSection = document.getElementById('calculatorSection');

        const notificationBadge = document.getElementById('notificationBadge');
        const notificationModal = document.getElementById('notificationModal');
        const notificationMessage = document.getElementById('notificationMessage');
        const notificationCategory = document.getElementById('notificationCategory');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const readNowBtn = document.getElementById('readNowBtn');
        const closeNotificationBtn = document.getElementById('closeNotificationBtn');
        const subscribeBtn = document.getElementById('subscribeBtn');
        const subscriptionToast = document.getElementById('subscriptionToast');

        // --- Data (Articles) ---
        const allArticles = [
            // Finance Articles
            { id: 1, category: "finance", title: "5 Smart Financial Planning Tips for Beginners", content: "<p>One of the steps that can make you certain of your future and attainment of your goals is financial planning. The 3 simple and genius tips of financial beginners are as follows:</p><h3>1. First Budgeting: Take control the First Step.</h3><p>2. Track Your Money: There is no way you can manage something you do not measure. The first thing to be done is to know how much cash you are collecting in a month. Write down the name of all of your sources of income and each and every expense, vaguely as your rent, to that cup of coffee. This will bring you a realistic impression of your financial patterns.</p><h3>3. Prepare a Budget That Works: Use the 50/ 30/ 20 rule, 50 equals needs, 30 equals wants, 20 equals savings or debt.</h3><p>4. Debts with High Interest Rates</p><p>5. Pay Yourself First: Save a small amount of money and then spend it first.</p>", image: "https://placehold.co/1200x630/2563EB/ffffff?text=Finance+Tips" },
            { id: 2, category: "finance", title: "How to Create a Monthly Budget That Actually Works", content: "<p>Creating an effective monthly budget is both an art and a science. It's a tool that can help you take control of your money. Follow the steps below:</p><h3>1. Find Your Monthly Income</h3><p>Add up your total income from all sources. This includes your salary, freelancing income, or any other regular income.</p><h3>2. Track All Your Expenses</h3><p>Record every expense you make for a month. This includes things like rent, electricity bills, groceries, and entertainment.</p><h3>3. Implement the 50/30/20 Rule</h3><p>This is a simple budgeting rule. Spend 50% of your income on \"Needs,\" 30% on \"Wants,\" and put 20% towards \"Savings & Debt.\"</p><h3>4. Customize the Budget</h3><p>Adjust your budget according to your goals and lifestyle. If you are saving for a house, you can increase the savings portion.</p><h3>5. Review Regularly</h3><p>Review your budget monthly. See where you were successful and where you need to improve. This will help you stay on track.</p>", image: "https://placehold.co/1200x630/60A5FA/ffffff?text=Budget+Works" },
            { id: 3, category: "finance", title: "Top 7 Investment Options for 2025", content: "<p>There are many investment options. Based on your financial goals and risk tolerance, you can choose from these top 7 options:</p><h3>1. Mutual Funds</h3><p>The most popular option for small investors. You can invest small amounts regularly through SIPs.</p><h3>2. Stock Market</h3><p>High return potential, but also high risk. Choose stocks of good companies for long-term investment.</p><h3>3. Government Schemes</h3><p>Options like Public Provident Fund (PPF) and National Pension Scheme (NPS) provide safe and tax-free returns.</p><h3>4. Real Estate</h3><p>A long-standing investment option. Buying property can give you both rental income and capital appreciation.</p><h3>5. Gold</h3><p>Considered a safe investment, especially during times of economic uncertainty. You can invest in physical gold or Sovereign Gold Bonds.</p><h3>6. Fixed Deposits</h3><p>A safe option for low-risk investors. You can open a fixed deposit with a bank or post office.</p><h3>7. Bonds and Debentures</h3><p>You can earn a fixed income by lending to a company or government. These are less volatile compared to mutual funds and stocks.</p>", image: "https://placehold.co/1200x630/10B981/ffffff?text=Investments" },
            { id: 11, category: "technology", title: "The Future of AI in Everyday Life", content: "<p>Artificial Intelligence is no longer a futuristic concept; it's being integrated into our daily lives. From smart home devices to personalized recommendations on streaming platforms, AI is everywhere. The next decade will see AI become even more seamless, anticipating our needs and automating complex tasks, transforming everything from healthcare to transportation.</p><h3>AI in Healthcare</h3><p>AI is being used to analyze medical images, predict disease outbreaks, and even assist in surgery. This is leading to faster diagnoses and more personalized treatment plans for patients.</p><h3>AI in Transportation</h3><p>Self-driving cars are just the beginning. AI is set to revolutionize logistics, public transit, and even air travel, making it safer and more efficient.</p><h3>AI and Personalization</h3><p>Imagine a smart assistant that not only organizes your calendar but also suggests the most efficient way to achieve your goals based on your habits. AI will take personalization to a new level, making our lives more convenient.</p>", image: "https://placehold.co/1200x630/F59E0B/ffffff?text=Future+of+AI" },
            { id: 12, category: "technology", title: "The Rise of Quantum Computing", content: "<p>Quantum computing uses the principles of quantum mechanics to process information, allowing it to solve problems that are currently impossible for even the most powerful supercomputers. While still in its infancy, it holds the potential to revolutionize fields like cryptography, drug discovery, and material science.</p><h3>How is it Different?</h3><p>Classical computers use bits (0s and 1s) to store data. Quantum computers use qubits, which can represent 0, 1, or both at the same time, thanks to a property called superposition. This allows them to perform complex calculations at an exponential speed.</p><h3>Challenges Ahead</h3><p>Despite its promise, quantum computing faces significant challenges, including the need for extremely low temperatures and the fragility of qubits. However, ongoing research is making rapid progress, bringing a quantum future closer to reality.</p>", image: "https://placehold.co/1200x630/EF4444/ffffff?text=Quantum+Tech" },
            { id: 13, category: "technology", title: "Cybersecurity Best Practices for 2025", content: "<p>As our digital world expands, so do cybersecurity threats. Protecting your personal and financial data is more critical than ever. Here are some key best practices to follow in 2025.</p><h3>1. Use Strong, Unique Passwords</h3><p>Avoid using simple passwords or reusing the same password across multiple sites. Use a password manager to securely store complex, unique passwords for all your accounts.</p><h3>2. Enable Multi-Factor Authentication (MFA)</h3><p>MFA adds an extra layer of security, requiring a second form of verification (like a code from your phone) in addition to your password.</p><h3>3. Keep Software Updated</h3><p>Regularly update your operating system and applications. Updates often include critical security patches that protect against new vulnerabilities.</p>", image: "https://placehold.co/1200x630/8B5CF6/ffffff?text=Cyber+Security" },
            { id: 14, category: "entertainment", title: "The Revival of Vinyl Records and Analog Media", content: "<p>In an increasingly digital world, there's a growing nostalgia and appreciation for analog media. The sales of vinyl records have surpassed CDs, and even cassette tapes are seeing a niche revival. This trend is driven by a desire for a tangible, high-quality audio experience and a connection to music history.</p><h3>The Audio Quality Debate</h3><p>Many audiophiles argue that the warmth and richness of analog sound cannot be replicated digitally. The process of listening to a vinyl record—cleaning it, dropping the needle—also adds a ritualistic element that enhances the experience.</p><h3>Collecting and Culture</h3><p>The rise of vinyl is also a cultural phenomenon. Collecting records has become a hobby, and local record stores have re-emerged as community hubs for music lovers.</p>", image: "https://placehold.co/1200x630/EC4899/ffffff?text=Vinyl+Revival" },
            { id: 15, category: "entertainment", title: "Top 5 Must-Watch Streaming Series of the Year", content: "<p>The streaming wars are heating up, providing an overwhelming amount of high-quality content. Here are the top five series everyone is talking about this year, ranging from gripping dramas to innovative science fiction:</p><h3>1. The Time Weaver (Sci-Fi)</h3><p>A complex narrative exploring parallel dimensions and time travel. Known for its stunning visuals and philosophical depth.</p><h3>2. The Corporate Ladder (Drama)</h3><p>A high-stakes drama detailing the cutthroat world of corporate finance, featuring incredible performances and intense plot twists.</p><h3>3. Midnight Garden (Mystery)</h3><p>A cozy mystery series set in a quiet European town, focusing on clever detective work and character development.</p><h3>4. Culinary Clash (Reality)</h3><p>A cooking competition show that challenges chefs with bizarre ingredients and historical recipes.</p><h3>5. Nebula's Children (Animation)</h3><p>A critically acclaimed adult animated series that blends dark humor with deep emotional themes about family and legacy.</p>", image: "https://placehold.co/1200x630/3B82F6/ffffff?text=Streaming+Hits" },
        ];


        // --- Utility Functions ---

        /**
         * Formats a number as a currency string (Indian Rupees).
         * @param {number} amount
         * @returns {string}
         */
        const formatCurrency = (amount) => {
            if (isNaN(amount)) return '₹0';
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(amount);
        };

        /**
         * Hides the article view and shows the main card grid.
         */
        const showCardGrid = () => {
            articleContainer.style.display = 'none';
            blogCards.parentElement.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        /**
         * Renders the article cards for the current category.
         * @param {string} category
         */
        const displayArticles = (category) => {
            currentCategory = category;
            articlesInCurrentCategory = allArticles.filter(a => a.category === category);

            // Update Header and Calculator Visibility
            sectionTitle.textContent = `${category.charAt(0).toUpperCase() + category.slice(1)} Articles`;
            
            if (category === 'finance') {
                calculatorSection.classList.remove('hidden');
            } else {
                calculatorSection.classList.add('hidden');
            }

            // Render Cards
            blogCards.innerHTML = '';
            showCardGrid(); // Ensure we are on the card view

            if (articlesInCurrentCategory.length === 0) {
                blogCards.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">No articles found in the ${category} category yet.</p>`;
                return;
            }

            articlesInCurrentCategory.forEach(article => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden cursor-pointer';
                card.dataset.id = article.id;
                
                card.innerHTML = `
                    <img src="${article.image}" alt="${article.title}" class="w-full h-48 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/600x400/e5e7eb/374151?text=Image+Unavailable';">
                    <div class="p-6">
                        <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full mb-2">${article.category.toUpperCase()}</span>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">${article.title}</h3>
                        <p class="text-gray-600 text-sm">${article.content.substring(0, 100).replace(/<[^>]*>?/gm, '')}...</p>
                        <button class="mt-4 text-blue-600 font-semibold text-sm hover:text-blue-800 transition-colors">Read More &rarr;</button>
                    </div>
                `;
                blogCards.appendChild(card);
            });

            // Update active navigation link styling
            navLinks.forEach(link => {
                link.classList.remove('border-white');
                if (link.dataset.category === category) {
                    link.classList.add('border-white');
                }
            });
        };

        /**
         * Displays the full content of a specific article.
         * @param {number} articleId
         */
        const showArticle = (articleId) => {
            const article = allArticles.find(a => a.id === articleId);
            if (!article) return;

            // Hide cards and show article container
            blogCards.parentElement.style.display = 'none';
            articleContainer.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Populate content
            articleTitleEl.textContent = article.title;
            articleTextEl.innerHTML = article.content;
            articleImageEl.src = article.image;
            articleImageEl.alt = article.title;

            currentArticleIndex = articlesInCurrentCategory.findIndex(a => a.id === articleId);
            
            // Update navigation buttons visibility
            backBtn.disabled = currentArticleIndex <= 0;
            nextBtn.disabled = currentArticleIndex >= articlesInCurrentCategory.length - 1;

            backBtn.classList.toggle('opacity-50', backBtn.disabled);
            nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
        };


        // --- Calculator Logic (Attached to window for inline onclick compatibility) ---

        window.calculateSIP = () => {
            const P = parseFloat(document.getElementById('sipAmount').value); // Monthly Investment
            const r_annual = parseFloat(document.getElementById('sipReturn').value) / 100; // Annual Rate
            const t = parseFloat(document.getElementById('sipYears').value); // Time in Years

            if (isNaN(P) || isNaN(r_annual) || isNaN(t) || P <= 0 || t <= 0) {
                document.getElementById('sipResult').textContent = "Please enter valid positive numbers.";
                return;
            }

            const r_monthly = r_annual / 12; // Monthly Rate
            const n_months = t * 12; // Total Months

            // Future Value of SIP formula: FV = P * [((1 + r)^n - 1) / r] * (1 + r)
            const FV = P * ((Math.pow(1 + r_monthly, n_months) - 1) / r_monthly) * (1 + r_monthly);
            const totalInvested = P * n_months;
            const estimatedReturn = FV - totalInvested;

            document.getElementById('sipResult').innerHTML = `
                <div class="text-sm font-normal text-gray-700">Total Investment: <span class="font-semibold">${formatCurrency(totalInvested)}</span></div>
                <div class="text-sm font-normal text-gray-700">Estimated Returns: <span class="font-semibold">${formatCurrency(estimatedReturn)}</span></div>
                <div class="text-xl mt-2 text-blue-700">Future Value: <span class="font-extrabold">${formatCurrency(FV)}</span></div>
            `;
        };

        window.calculateLumpsum = () => {
            const P = parseFloat(document.getElementById('lumpsumAmount').value); // Principal
            const r = parseFloat(document.getElementById('lumpsumReturn').value) / 100; // Annual Rate
            const t = parseFloat(document.getElementById('lumpsumYears').value); // Time in Years

            if (isNaN(P) || isNaN(r) || isNaN(t) || P <= 0 || t <= 0) {
                document.getElementById('lumpsumResult').textContent = "Please enter valid positive numbers.";
                return;
            }

            // Compound Interest Formula: A = P(1 + r)^t
            const FV = P * Math.pow(1 + r, t);
            const estimatedReturn = FV - P;

            document.getElementById('lumpsumResult').innerHTML = `
                <div class="text-sm font-normal text-gray-700">Total Investment: <span class="font-semibold">${formatCurrency(P)}</span></div>
                <div class="text-sm font-normal text-gray-700">Estimated Returns: <span class="font-semibold">${formatCurrency(estimatedReturn)}</span></div>
                <div class="text-xl mt-2 text-blue-700">Future Value: <span class="font-extrabold">${formatCurrency(FV)}</span></div>
            `;
        };


        // --- Firebase/Firestore Logic ---

        /**
         * Saves the user's subscription status to Firestore.
         */
        const updateUserSubscription = async (isSubscribed) => {
            if (!db || !userId) {
                console.error("Firestore or User ID not ready for subscription update.");
                return;
            }
            try {
                // Private user document: /artifacts/{appId}/users/{userId}/user_preferences/current_user
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_preferences/current_user`);
                await setDoc(userDocRef, { 
                    isSubscribed: isSubscribed,
                    updatedAt: Date.now()
                }, { merge: true });

                console.log(`Subscription status updated successfully to: ${isSubscribed}`);
                userHasSubscribed = isSubscribed;
                updateSubscribeButtonUI(isSubscribed);

                if (isSubscribed) {
                    showToast();
                }

            } catch (e) {
                console.error("Error updating user subscription:", e);
            }
        };

        /**
         * Sets up the real-time listener for the latest global notification.
         */
        const setupNotificationListener = () => {
            if (!db) {
                console.error("Firestore not ready for notification listener.");
                return;
            }

            // Public document: /artifacts/{appId}/public/data/notifications/latest
            const notificationDocRef = doc(db, `artifacts/${appId}/public/data/notifications/latest`);

            onSnapshot(notificationDocRef, (docSnap) => {
                if (docSnap.exists() && isAuthReady) {
                    const latestNotification = docSnap.data();
                    
                    // The badge is shown if:
                    // 1. The user is globally subscribed OR
                    // 2. The notification category matches the current view.
                    const matchesCategory = latestNotification.category && latestNotification.category.toLowerCase() === currentCategory.toLowerCase();
                    
                    if (userHasSubscribed || matchesCategory) {
                        notificationBadge.classList.remove('hidden');
                        notificationModal.dataset.title = latestNotification.title || "New Update";
                        notificationModal.dataset.message = latestNotification.message || "You have a new update.";
                        notificationModal.dataset.category = latestNotification.category || "General";
                        notificationModal.dataset.link = latestNotification.link || "#";
                    } else {
                        notificationBadge.classList.add('hidden');
                    }
                } else {
                    notificationBadge.classList.add('hidden');
                }
            }, (error) => {
                console.error("Error listening to notifications:", error);
            });
        };

        /**
         * Fetches and applies the initial user preferences.
         */
        const loadUserPreferences = async () => {
            if (!db || !userId) return;

            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_preferences/current_user`);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userHasSubscribed = data.isSubscribed === true;
                } else {
                    // Create a default preference document if none exists
                    await updateUserSubscription(false);
                }
                updateSubscribeButtonUI(userHasSubscribed);
            } catch (e) {
                console.error("Error loading user preferences:", e);
            }
        };
        
        // --- UI Update Functions ---
        
        /**
         * Shows the subscription success toast.
         */
        const showToast = () => {
            subscriptionToast.classList.add('show');
            setTimeout(() => {
                subscriptionToast.classList.remove('show');
            }, 3000);
        };

        /**
         * Updates the subscribe button text and color based on subscription status.
         */
        const updateSubscribeButtonUI = (isSubscribed) => {
            if (isSubscribed) {
                subscribeBtn.textContent = 'Subscribed (Thank You!)';
                subscribeBtn.classList.remove('bg-white', 'text-blue-600');
                subscribeBtn.classList.add('bg-green-500', 'text-white');
                subscribeBtn.disabled = true;
            } else {
                subscribeBtn.textContent = 'Subscribe to All Updates';
                subscribeBtn.classList.remove('bg-green-500', 'text-white');
                subscribeBtn.classList.add('bg-white', 'text-blue-600');
                subscribeBtn.disabled = false;
            }
        };

        /**
         * Shows the notification modal.
         */
        const showNotificationModal = () => {
            const title = notificationModal.dataset.title;
            const message = notificationModal.dataset.message;
            const category = notificationModal.dataset.category;
            const link = notificationModal.dataset.link;
            
            notificationMessage.textContent = message;
            notificationCategory.textContent = category;
            readNowBtn.href = link;

            notificationModal.classList.add('show');
            notificationBadge.classList.add('hidden'); // Hide badge after user opens modal
        };

        /**
         * Hides the notification modal.
         */
        const hideNotificationModal = () => {
            notificationModal.classList.remove('show');
        };


        // --- Event Listeners and Initialization ---

        // 1. Firebase Initialization and Authentication
        window.onload = async () => {
            if (Object.keys(firebaseConfig).length > 0) {
                try {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                } catch (e) {
                    console.error("Failed to initialize Firebase:", e);
                }
            } else {
                console.warn("Firebase config is missing. Services will not be available.");
                // Still run UI initialization even if Firebase is missing
                isAuthReady = true;
                displayArticles(currentCategory);
                return; 
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in (anonymous or custom token)
                    userId = user.uid;
                } else if (initialAuthToken) {
                    // Sign in with provided custom token
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        userId = auth.currentUser.uid;
                    } catch (error) {
                        console.error("Custom token sign-in failed:", error);
                        // Fallback to anonymous sign-in
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                    }
                } else {
                    // Fallback to anonymous sign-in
                    await signInAnonymously(auth);
                    userId = auth.currentUser.uid;
                }
                
                isAuthReady = true;
                userIdDisplay.textContent = `User ID: ${userId}`;
                await loadUserPreferences(); // Load subscription status
                setupNotificationListener(); // Start listening for notifications
                displayArticles(currentCategory); // Initial load of articles
            });
        };


        // 2. Navigation Link Handlers
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const newCategory = link.dataset.category;
                if (newCategory !== currentCategory) {
                    displayArticles(newCategory);
                }
            });
        });

        // 3. Article Card Click Handler
        blogCards.addEventListener('click', (e) => {
            const card = e.target.closest('[data-id]');
            if (card) {
                const articleId = parseInt(card.dataset.id);
                showArticle(articleId);
            }
        });

        // 4. Article Navigation (Back/Next)
        backBtn.addEventListener('click', () => {
            if (currentArticleIndex > 0) {
                showArticle(articlesInCurrentCategory[currentArticleIndex - 1].id);
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentArticleIndex < articlesInCurrentCategory.length - 1) {
                showArticle(articlesInCurrentCategory[currentArticleIndex + 1].id);
            }
        });

        // 5. Back to Articles Button
        document.getElementById('backBtn').addEventListener('click', showCardGrid);


        // 6. Subscription and Notification UI Handlers
        subscribeBtn.addEventListener('click', () => {
            if (!userHasSubscribed) {
                updateUserSubscription(true);
            }
        });

        notificationBtn.addEventListener('click', () => {
            if (notificationBadge.classList.contains('hidden') && !notificationModal.classList.contains('show')) {
                // If the badge is hidden and the modal is closed, there's no new notification to show, do nothing.
                console.log("No new notification to display.");
                return;
            }
            showNotificationModal();
        });

        closeNotificationBtn.addEventListener('click', hideNotificationModal);
        readNowBtn.addEventListener('click', hideNotificationModal);

        // Initial setup for calculators (in case the onclick attributes fail)
        document.getElementById('sipCalcBtn').addEventListener('click', window.calculateSIP);
        document.getElementById('lumpsumCalcBtn').addEventListener('click', window.calculateLumpsum);

        // Initial calculator run on load for default values
        document.addEventListener('DOMContentLoaded', () => {
            window.calculateSIP();
            window.calculateLumpsum();
        });

    </script>
</body>
</html>
